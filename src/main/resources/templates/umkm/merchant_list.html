<!doctype html>
<html lang="id" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{base_layout}">
<head>
    <title th:text="#{merchant.title}"></title>
</head>
<body>

<section layout:fragment="content">

    <!-- Page Header -->
    <div class="page-header">
        <div>
            <h3 th:text="#{merchant.title}">Manajemen Pedagang</h3>
            <p th:text="#{merchant.subtitle}">Daftar Pedagang UMKM yang terdaftar di sistem</p>
        </div>
        <a th:if="${role == 'ADMIN'}" th:href="@{/merchants/add}" class="btn-add-merchant">
            <i class="fa fa-plus"></i>
            <span th:text="#{merchant.add}">Tambah Pedagang</span>
        </a>
    </div>

    <!-- Alert Success -->
    <div th:if="${success}" class="alert alert-success alert-dismissible fade show mb-4" role="alert">
        <i class="fa fa-check-circle me-2"></i>
        <span th:text="${success}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <!-- Table Card -->
    <div class="merchant-card">

        <!-- Toolbar: Search + Per Page -->
        <form th:action="@{/merchants}" method="get" class="merchant-toolbar">
            <div class="search-wrap">
                <i class="fa fa-search search-icon" style="font-size:13px;"></i>
                <input type="text"
                       name="search"
                       class="search-input"
                       placeholder="Cari nama pedagang..."
                       th:value="${search}"
                       autocomplete="off"/>
            </div>
            <button type="submit" class="btn-tbl btn-tbl-view" style="padding:9px 14px;">
                <i class="fa fa-search"></i> Cari
            </button>
            <div class="toolbar-right">
                <span class="per-page-label">Tampilkan:</span>
                <select name="size" class="per-page-select" onchange="this.form.submit()">
                    <option value="5"  th:selected="${size == 5}">5</option>
                    <option value="10" th:selected="${size == 10}">10</option>
                    <option value="25" th:selected="${size == 25}">25</option>
                </select>
                <!-- preserve search on size change -->
                <input type="hidden" name="search" th:value="${search}"/>
            </div>
        </form>

        <!-- Table -->
        <table class="merchant-table">
            <thead>
            <tr>
                <th class="th-no">#</th>
                <th th:text="#{merchant.name}">Nama Pedagang</th>
                <th>Status</th>
                <th class="th-action" th:text="#{action}">Aksi</th>
            </tr>
            </thead>
            <tbody>
            <tr th:if="${merchants.empty}">
                <td colspan="4">
                    <div class="empty-state">
                        <i class="fa fa-store"></i>
                        <p>Tidak ada pedagang ditemukan</p>
                        <small th:if="${search != null and search != ''}">Coba ubah kata kunci pencarian</small>
                        <small th:unless="${search != null and search != ''}">Belum ada pedagang yang terdaftar</small>
                    </div>
                </td>
            </tr>
            <tr th:each="m, iter : ${merchants}">
                <td class="td-no" th:text="${(currentPage - 1) * size + iter.count}">1</td>
                <td><span class="merchant-name" th:text="${m.name}"></span></td>
                <td>
                            <span th:if="${m.status != null}"
                                  th:classappend="${m.status.toLowerCase() == 'aktif' ? 'aktif' : 'nonaktif'}"
                                  class="status-badge">
                                <span class="dot"></span>
                                <span th:text="${m.status}"></span>
                            </span>
                    <span th:unless="${m.status != null}" class="status-badge nonaktif">
                                <span class="dot"></span> Nonaktif
                            </span>
                </td>
                <td class="td-action">
                    <div class="action-group">
                        <a th:href="@{/merchants/{id}(id=${m.id})}"
                           class="btn-tbl btn-tbl-view">
                            <i class="fa fa-eye"></i> Lihat
                        </a>
                        <a th:if="${role == 'ADMIN'}"
                           th:href="@{/merchants/{id}/edit(id=${m.id})}"
                           class="btn-tbl btn-tbl-edit">
                            <i class="fa fa-pencil"></i> Ubah
                        </a>
                        <button th:if="${role == 'ADMIN'}"
                                type="button"
                                class="btn-tbl btn-tbl-delete"
                                th:attr="data-id=${m.id}, data-name=${m.name}"
                                onclick="confirmDelete(this)">
                            <i class="fa fa-trash"></i> Hapus
                        </button>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>

        <!-- Pagination -->
        <div class="pagination-wrapper">
            <div class="pagination-info">
                    <span th:if="${totalElements > 0}">
                        Menampilkan
                        <strong th:text="${(currentPage - 1) * size + 1}">1</strong>–<strong th:text="${(currentPage - 1) * size + merchants.size()}">5</strong>
                        dari <strong th:text="${totalElements}">0</strong> pedagang
                    </span>
                <span th:unless="${totalElements > 0}">Tidak ada data</span>
            </div>
            <nav class="pagination-nav" th:if="${totalPages > 1}">
                <!-- Prev -->
                <a th:classappend="${currentPage == 1 ? 'disabled' : ''}"
                   th:href="@{/merchants(page=${currentPage - 1}, size=${size}, search=${search})}"
                   class="page-btn">‹</a>
                <!-- Pages -->
                <th:block th:each="i : ${#numbers.sequence(1, totalPages)}">
                    <a th:classappend="${i == currentPage ? 'active' : ''}"
                       th:href="@{/merchants(page=${i}, size=${size}, search=${search})}"
                       th:text="${i}"
                       class="page-btn">1</a>
                </th:block>
                <!-- Next -->
                <a th:classappend="${currentPage == totalPages ? 'disabled' : ''}"
                   th:href="@{/merchants(page=${currentPage + 1}, size=${size}, search=${search})}"
                   class="page-btn">›</a>
            </nav>
        </div>
    </div>

    <!-- Modal Konfirmasi Hapus -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border-radius:14px;overflow:hidden;border:none;box-shadow:0 10px 40px rgba(0,0,0,0.15);">
                <div class="modal-header modal-header-danger">
                    <h5 class="modal-title">
                        <i class="fa fa-triangle-exclamation me-2"></i>Konfirmasi Hapus
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body py-4 px-4">
                    <p style="font-size:15px;color:#334155;line-height:1.6;margin:0;">
                        Apakah kamu yakin ingin menghapus pedagang
                        <strong id="deleteMerchantName" style="color:#0f172a;"></strong>?
                        <br><span style="font-size:13px;color:#64748b;">Tindakan ini tidak dapat dibatalkan.</span>
                    </p>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <form id="deleteForm" th:action="@{/merchants/0/delete}" method="post">
                        <button type="submit" class="btn-confirm-delete">
                            <i class="fa fa-trash me-1"></i> Hapus
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        function confirmDelete(btn) {
            const id   = btn.getAttribute('data-id');
            const name = btn.getAttribute('data-name');
            document.getElementById('deleteMerchantName').textContent = '"' + name + '"';
            document.getElementById('deleteForm').action = '/merchants/' + id + '/delete';
            const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
            modal.show();
        }
    </script>
</section>

</body>
</html>
